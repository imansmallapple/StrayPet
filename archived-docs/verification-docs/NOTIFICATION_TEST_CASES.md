# 我的消息功能 - 测试文档

## 📋 测试概述

本文档提供了完整的测试用例来验证"我的消息"功能的实现。

## 🔧 测试环境准备

### 前提条件

1. Python 3.11+ 已安装
2. Node.js 16+ 已安装
3. pnpm 已安装
4. 项目依赖已安装

### 启动服务

```bash
# 终端 1: 启动后端
cd backend
python manage.py runserver

# 终端 2: 启动前端
cd frontend
pnpm dev
```

### 登录系统

1. 打开浏览器访问 http://localhost:5173
2. 完成登录
3. 记下获得的 JWT token（从浏览器开发者工具的 localStorage 中复制）

## 📝 测试用例

### TC001: 访问消息中心

**目标**: 验证用户可以访问消息中心

**步骤**:

1. 登录系统
2. 点击用户头像进入用户资料页面
3. 滚动到"消息中心"部分
4. 查看"回复我的"和"我的消息"两个标签页

**预期结果**:

- ✅ 页面正常加载
- ✅ 两个标签页都可见
- ✅ "回复我的"标签页已选中（默认）
- ✅ 没有 JavaScript 错误

### TC002: 查看通知列表（无数据）

**目标**: 验证空状态下的正常显示

**步骤**:

1. 在消息中心点击"我的消息"标签页
2. 等待加载完成
3. 观察显示内容

**预期结果**:

- ✅ 显示加载动画（最多 2 秒）
- ✅ 加载完成后显示"暂无消息"提示
- ✅ UI 布局正确，没有样式错误
- ✅ 控制台没有错误

### TC003: 查看通知列表（有数据）

**目标**: 验证通知数据的正确显示

**前置条件**: 数据库中已有通知数据

**步骤**:

1. 在消息中心点击"我的消息"标签页
2. 等待加载完成
3. 检查通知列表

**预期结果**:

- ✅ 显示通知卡片列表
- ✅ 每张卡片显示以下信息：
  - 发送者名称
  - 通知标题
  - 通知内容
  - 发送时间（相对格式）
  - 新 Badge（未读时）
  - 标记已读按钮

### TC004: 检查通知卡片内容

**目标**: 验证通知卡片显示的信息准确

**步骤**:

1. 打开消息中心的"我的消息"标签页
2. 查看第一条通知卡片
3. 验证每个字段的内容

**预期结果**:

- ✅ 发送者名称与数据库一致
- ✅ 标题与数据库一致
- ✅ 内容与数据库一致
- ✅ 时间格式正确（刚刚/X 分钟前/X 小时前/X 天前/日期）
- ✅ 已读状态显示正确

**示例验证**:

```
通知卡片应该类似于：
┌─────────────────────────────────┐
│ system      ✨ NEW  刚刚        │ ← 发送者 Badge 时间
├─────────────────────────────────┤
│ 欢迎来到 StrayPet              │ ← 标题
│ 感谢您加入我们的社区！          │ ← 内容
├─────────────────────────────────┤
│ [标记已读]                      │ ← 操作按钮
└─────────────────────────────────┘
```

### TC005: 标记单个通知为已读

**目标**: 验证标记为已读功能

**步骤**:

1. 打开消息中心的"我的消息"标签页
2. 找到一条未读通知（有"新"Badge）
3. 点击"标记已读"按钮
4. 观察 UI 变化

**预期结果**:

- ✅ 点击后立即消失加载动画
- ✅ "新"Badge 消失
- ✅ "标记已读"按钮隐藏
- ✅ 没有页面刷新
- ✅ 后台成功调用 API

### TC006: API 调用验证

**目标**: 验证前后端 API 通信正确

**步骤**:

1. 打开浏览器开发者工具（F12）
2. 切换到 Network 标签
3. 打开消息中心的"我的消息"标签页
4. 观察网络请求

**预期结果**:

- ✅ 发起 GET 请求到 `/user/notifications/`
- ✅ 请求头包含 `Authorization: Bearer <token>`
- ✅ 响应状态码为 200
- ✅ 响应体包含 `count`, `next`, `previous`, `results` 字段
- ✅ `results` 是数组，包含通知对象

**验证响应格式**:

```json
{
  "count": 10,
  "next": "?page=2",
  "previous": null,
  "results": [
    {
      "id": 1,
      "notification_type": "system",
      "title": "欢迎来到 StrayPet",
      "content": "感谢您加入我们的社区！",
      "from_user": {
        "id": 1,
        "username": "system"
      },
      "is_read": false,
      "created_at": "2024-12-29T10:30:00Z",
      "read_at": null
    }
  ]
}
```

### TC007: 错误处理 - 未登录

**目标**: 验证未登录用户被正确拒绝

**步骤**:

1. 清除 localStorage 中的 accessToken
2. 刷新页面
3. 打开消息中心的"我的消息"标签页
4. 观察错误处理

**预期结果**:

- ✅ API 返回 401 Unauthorized
- ✅ 前端显示"请重新登录"错误提示
- ✅ 没有崩溃

### TC008: 错误处理 - Token 过期

**目标**: 验证 token 过期的处理

**步骤**:

1. 修改 localStorage 中的 accessToken 为无效值
2. 打开消息中心的"我的消息"标签页
3. 观察错误处理

**预期结果**:

- ✅ API 返回 401 Unauthorized
- ✅ 前端显示"请重新登录"错误提示

### TC009: 分页功能

**目标**: 验证分页功能工作正常

**前置条件**: 数据库中有超过 10 条通知

**步骤**:

1. 打开消息中心的"我的消息"标签页
2. 查看显示的通知数量
3. 修改前端代码中的 `page_size` 为较小的值（如 5）
4. 观察是否支持获取下一页数据

**预期结果**:

- ✅ 默认显示 10 条通知
- ✅ 通过修改 page 参数可以获取其他页面的数据
- ✅ 响应中的 `count` 字段表示总通知数
- ✅ `next` 和 `previous` 字段正确指示是否有下一页和上一页

### TC010: 标签页切换

**目标**: 验证在标签页间切换时的行为

**步骤**:

1. 打开消息中心
2. 在"回复我的"和"我的消息"之间切换
3. 多次切换观察行为

**预期结果**:

- ✅ 切换时显示加载动画
- ✅ 数据正确加载
- ✅ 之前的加载状态被清除
- ✅ 没有内存泄漏

### TC011: 长列表性能

**目标**: 验证加载大量通知时的性能

**前置条件**: 创建 100+ 条测试通知

**步骤**:

1. 打开消息中心的"我的消息"标签页
2. 使用浏览器性能工具测试
3. 观察 UI 渲染性能

**预期结果**:

- ✅ 页面响应时间 < 2 秒
- ✅ 列表滚动流畅（FPS > 30）
- ✅ 没有卡顿

### TC012: 响应式设计

**目标**: 验证不同屏幕尺寸下的显示

**步骤**:

1. 打开消息中心
2. 使用浏览器开发者工具切换不同设备尺寸：
   - 手机 (375x667)
   - 平板 (768x1024)
   - 桌面 (1920x1080)
3. 观察 UI 显示

**预期结果**:

- ✅ 所有尺寸下都能正常显示
- ✅ 通知卡片自适应布局
- ✅ 按钮和交互元素易于点击

### TC013: 浏览器兼容性

**目标**: 验证在不同浏览器上的兼容性

**步骤**:
在以下浏览器上测试：

- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+

**测试内容**:

1. 打开消息中心
2. 加载通知列表
3. 标记通知为已读
4. 检查开发者工具是否有错误

**预期结果**:

- ✅ 所有浏览器上都能正常工作
- ✅ 没有兼容性警告

## 🔧 手动 API 测试

### 使用 curl 测试

```bash
# 获取通知列表
curl -H "Authorization: Bearer YOUR_TOKEN" \
     "http://localhost:8000/user/notifications/?page=1&page_size=10"

# 标记通知为已读
curl -X POST \
     -H "Authorization: Bearer YOUR_TOKEN" \
     "http://localhost:8000/user/notifications/1/mark_as_read/"

# 标记所有通知为已读
curl -X POST \
     -H "Authorization: Bearer YOUR_TOKEN" \
     "http://localhost:8000/user/notifications/mark_all_as_read/"
```

### 使用 Postman 测试

1. 创建 GET 请求到 `http://localhost:8000/user/notifications/`
2. 在 Headers 中添加 `Authorization: Bearer YOUR_TOKEN`
3. 在 Params 中添加 `page=1, page_size=10`
4. 点击 Send

## 📊 测试结果记录

| 测试用例 | 状态 | 备注   | 日期 |
| -------- | ---- | ------ | ---- |
| TC001    | ⏳   | 待测试 | -    |
| TC002    | ⏳   | 待测试 | -    |
| TC003    | ⏳   | 待测试 | -    |
| TC004    | ⏳   | 待测试 | -    |
| TC005    | ⏳   | 待测试 | -    |
| TC006    | ⏳   | 待测试 | -    |
| TC007    | ⏳   | 待测试 | -    |
| TC008    | ⏳   | 待测试 | -    |
| TC009    | ⏳   | 待测试 | -    |
| TC010    | ⏳   | 待测试 | -    |
| TC011    | ⏳   | 待测试 | -    |
| TC012    | ⏳   | 待测试 | -    |
| TC013    | ⏳   | 待测试 | -    |

## 🐛 问题反馈模板

如果发现问题，请填写以下信息：

```
### 问题描述
[简要描述问题]

### 重现步骤
1. [步骤 1]
2. [步骤 2]
3. [步骤 3]

### 预期行为
[应该发生什么]

### 实际行为
[实际发生了什么]

### 环境信息
- 浏览器: [浏览器名称和版本]
- 操作系统: [OS 名称和版本]
- 时间: [问题发生的时间]

### 控制台错误
[粘贴任何 JavaScript 错误]

### 网络请求信息
[粘贴失败的 API 请求详情]
```

## ✅ 测试完成检查清单

测试完成后，请确认：

- [ ] 所有 13 个测试用例已执行
- [ ] 至少 11 个测试用例通过
- [ ] 所有严重问题已解决
- [ ] API 响应时间可接受（< 2 秒）
- [ ] 没有 JavaScript 错误
- [ ] UI 显示正确
- [ ] 浏览器兼容性验证完成
- [ ] 性能测试通过

---

**最后更新**: 2024-12-29
**测试文档版本**: v1.0
